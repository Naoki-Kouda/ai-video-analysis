<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動画分析ツール - AI Video Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        @media print {
            .no-print { display: none; }
            body { background: white; color: black; }
        }
        
        /* カスタムスクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        
        <!-- ヘッダー -->
        <div class="text-center mb-12 no-print">
            <h1 class="text-5xl font-bold mb-3 gradient-bg bg-clip-text text-transparent" style="-webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                AI Video Analyzer
            </h1>
            <p class="text-gray-400 text-lg tracking-wide">動画分析ツール</p>
            <div class="mt-4 h-1 w-32 mx-auto gradient-bg rounded-full"></div>
        </div>

        <!-- アップロードセクション -->
        <div id="upload-section" class="bg-gray-800 rounded-xl shadow-2xl p-10">
            <div class="text-center">
                <div class="border-4 border-dashed border-gray-600 rounded-xl p-16 mb-8 hover:border-purple-500 transition-all duration-300 cursor-pointer hover:bg-gray-750" id="drop-zone">
                    <svg class="w-20 h-20 mx-auto mb-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="text-2xl mb-3 font-semibold text-gray-200">動画ファイルを選択</p>
                    <p class="text-gray-400 text-sm mb-6">または、ここにドラッグ&ドロップ</p>
                    <input type="file" id="video-input" accept="video/*" class="hidden">
                    <button onclick="document.getElementById('video-input').click()" 
                            class="gradient-bg hover:opacity-90 px-8 py-3 rounded-lg font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        ファイルを選択
                    </button>
                    <p class="text-gray-500 text-xs mt-6">対応形式: MP4, MOV, AVI, WebM | 最大サイズ: 100MB</p>
                </div>
                
                <div id="file-info" class="hidden mb-8 p-5 bg-gray-700 rounded-lg border border-gray-600">
                    <div class="flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        <p class="text-sm">選択されたファイル: <span id="file-name" class="font-semibold text-purple-400"></span></p>
                    </div>
                </div>
                
                <button id="analyze-btn" 
                        onclick="startAnalysis()" 
                        disabled
                        class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 disabled:from-gray-600 disabled:to-gray-600 disabled:cursor-not-allowed px-8 py-5 rounded-xl font-bold text-xl transition-all duration-300 transform hover:scale-105 disabled:transform-none shadow-2xl hover:shadow-purple-500/50">
                    分析を開始
                </button>
            </div>
        </div>

        <!-- 分析中セクション -->
        <div id="analyzing-section" class="hidden bg-gray-800 rounded-xl shadow-2xl p-12">
            <div class="text-center">
                <h2 class="text-3xl font-bold mb-10">分析処理中</h2>
                <div class="flex justify-center mb-10">
                    <div class="spinner"></div>
                </div>
                <p class="text-gray-300 text-xl pulse mb-3">AIが動画コンテンツを分析しています</p>
                <p class="text-gray-500 text-sm">動画の長さにより1〜3分程度かかります</p>
                
                <div class="mt-10 pt-10 border-t border-gray-700">
                    <p class="text-gray-400 text-sm">処理内容</p>
                    <ul class="mt-4 space-y-2 text-gray-500 text-sm">
                        <li>✓ フレーム抽出</li>
                        <li>✓ 画像解析</li>
                        <li>✓ コンテンツ分類</li>
                        <li>✓ レポート生成</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 結果表示セクション -->
        <div id="result-section" class="hidden">
            
            <!-- 成功メッセージ -->
            <div class="bg-gradient-to-r from-green-900 to-emerald-900 border border-green-700 rounded-xl p-8 mb-8 text-center no-print shadow-xl">
                <svg class="w-16 h-16 mx-auto mb-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-3xl font-bold mb-2">分析完了</p>
                <p class="text-gray-300 mt-2">動画の詳細な分析結果が生成されました</p>
            </div>

            <!-- PDF/印刷ボタン -->
            <div class="flex justify-end mb-8 no-print gap-3">
                {% if weasyprint_available %}
                <a href="/pdf" target="_blank" 
                   class="inline-flex items-center bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold transition-all duration-300 shadow-lg hover:shadow-xl">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    PDF ダウンロード
                </a>
                {% else %}
                <button onclick="window.print()" 
                        class="inline-flex items-center bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold transition-all duration-300 shadow-lg hover:shadow-xl">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                    </svg>
                    印刷してPDF保存
                </button>
                {% endif %}
            </div>

            <!-- ジャンル判定 -->
            <div class="bg-gray-800 rounded-xl shadow-xl p-8 mb-8 border border-gray-700">
                <div class="flex items-center mb-6">
                    <svg class="w-8 h-8 mr-3 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                    <h2 class="text-3xl font-bold">ジャンル判定</h2>
                </div>
                <div class="bg-gradient-to-br from-gray-700 to-gray-750 rounded-xl p-8 border border-gray-600">
                    <p class="text-4xl font-bold text-purple-400 mb-3" id="genre"></p>
                    <div class="mb-4">
                        <span class="text-gray-400 text-sm">信頼度:</span>
                        <span id="genre-confidence" class="text-green-400 font-bold text-xl ml-2"></span>
                        <span class="text-green-400 text-xl">%</span>
                    </div>
                    <div class="h-px bg-gray-600 my-4"></div>
                    <p class="text-gray-300 leading-relaxed" id="genre-reason"></p>
                </div>
            </div>

            <!-- パート別サマリー -->
            <div class="bg-gray-800 rounded-xl shadow-xl p-8 mb-8 border border-gray-700">
                <div class="flex items-center mb-6">
                    <svg class="w-8 h-8 mr-3 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h2 class="text-3xl font-bold">パート別サマリー</h2>
                </div>
                <div id="parts-container" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <!-- パートが動的に追加される -->
                </div>
            </div>

            <!-- 編集アドバイス -->
            <div class="bg-gray-800 rounded-xl shadow-xl p-8 mb-8 border border-gray-700">
                <div class="flex items-center mb-6">
                    <svg class="w-8 h-8 mr-3 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <h2 class="text-3xl font-bold">バズらせるための編集アドバイス</h2>
                </div>
                <div id="advice-container" class="space-y-5">
                    <!-- アドバイスが動的に追加される -->
                </div>
            </div>

            <!-- 再分析ボタン -->
            <div class="text-center no-print">
                <button onclick="resetPage()" 
                        class="inline-flex items-center bg-gray-700 hover:bg-gray-600 px-10 py-4 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    新しい動画を分析
                </button>
            </div>
        </div>

    </div>

    <script>
        let selectedFile = null;

        // ファイル選択処理
        const videoInput = document.getElementById('video-input');
        const dropZone = document.getElementById('drop-zone');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const analyzeBtn = document.getElementById('analyze-btn');

        videoInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                fileName.textContent = selectedFile.name;
                fileInfo.classList.remove('hidden');
                analyzeBtn.disabled = false;
            }
        });

        // ドラッグ&ドロップ
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-purple-500', 'bg-gray-750');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-purple-500', 'bg-gray-750');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-purple-500', 'bg-gray-750');
            
            if (e.dataTransfer.files.length > 0) {
                selectedFile = e.dataTransfer.files[0];
                fileName.textContent = selectedFile.name;
                fileInfo.classList.remove('hidden');
                analyzeBtn.disabled = false;
            }
        });

        // 分析開始
        async function startAnalysis() {
            if (!selectedFile) {
                alert('動画ファイルを選択してください');
                return;
            }

            // UIを分析中に切り替え
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('analyzing-section').classList.remove('hidden');

            // フォームデータ作成
            const formData = new FormData();
            formData.append('video', selectedFile);

            try {
                // サーバーに送信
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '分析に失敗しました');
                }

                // 結果表示
                displayResults(data.report);

            } catch (error) {
                alert('エラー: ' + error.message);
                resetPage();
            }
        }

        // 結果表示
        function displayResults(report) {
            // 分析中を非表示
            document.getElementById('analyzing-section').classList.add('hidden');
            
            // 結果セクションを表示
            document.getElementById('result-section').classList.remove('hidden');

            // ジャンル判定
            document.getElementById('genre').textContent = report.genre;
            document.getElementById('genre-confidence').textContent = report.genre_confidence;
            document.getElementById('genre-reason').textContent = report.genre_reason;

            // パート別サマリー
            const partsContainer = document.getElementById('parts-container');
            partsContainer.innerHTML = '';
            
            report.parts.forEach((part, index) => {
                const partDiv = document.createElement('div');
                partDiv.className = 'bg-gradient-to-br from-gray-700 to-gray-750 rounded-xl p-6 border border-gray-600 hover:border-purple-500 transition-all duration-300';
                partDiv.innerHTML = `
                    <div class="flex items-center mb-3">
                        <span class="bg-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm mr-3">${String.fromCharCode(65 + index)}</span>
                        <h3 class="text-xl font-bold text-purple-400">${part.name}</h3>
                    </div>
                    <p class="text-gray-400 text-sm mb-3">${part.timerange}</p>
                    <p class="text-gray-300 leading-relaxed">${part.summary}</p>
                `;
                partsContainer.appendChild(partDiv);
            });

            // 編集アドバイス
            const adviceContainer = document.getElementById('advice-container');
            adviceContainer.innerHTML = '';
            
            report.advice.forEach((advice, index) => {
                const adviceDiv = document.createElement('div');
                adviceDiv.className = 'bg-gradient-to-br from-gray-700 to-gray-750 rounded-xl p-6 border border-gray-600 hover:border-yellow-500 transition-all duration-300';
                adviceDiv.innerHTML = `
                    <div class="flex items-start mb-4">
                        <span class="bg-yellow-500 text-gray-900 rounded-lg px-3 py-1 font-bold text-sm mr-3 flex-shrink-0">${index + 1}</span>
                        <h3 class="text-xl font-bold text-yellow-400">${advice.title.replace(/^\d+\.\s*/, '')}</h3>
                    </div>
                    <p class="text-gray-300 leading-relaxed whitespace-pre-line">${advice.content}</p>
                `;
                adviceContainer.appendChild(adviceDiv);
            });

            // ページトップにスクロール
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ページリセット
        function resetPage() {
            location.reload();
        }
    </script>

</body>
</html>
